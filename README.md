## WASI HTTP Proxy

Updated version of `sunfishcode` example project using WASI `0.2.0` (aka Preview2) WIT definitions.


---

### Required tools 

Install `wasmtime` 17.0.x (or higher) as this provides WASI `0.2.0`.

```shell
curl https://wasmtime.dev/install.sh -sSf | bash
```

Install `cargo component`
```shell
cargo install cargo-component
```

Optionally install `cargo-expand`. I find this easier to make sense of generated bindings.

```shell
cargo install cargo-expand
```

--- 

### Create the project

Run the following command to initialise the project.

Note the use of the `--reactor` switch. By default, `cargo component` will create a `command` project type.

For an explanation of `Commands and Reactors` see [links](#links)


```shell
cargo component new --reactor hello-wasi-http 
cd hello-wasi-http
```

The following directory structure will be generated by `cargo component`
```shell
# ~/nakame/hello-wasi-http main*
❯ tree .
.
├── Cargo.lock
├── Cargo.toml
├── src
│ └── lib.rs
└── wit
    └── world.wit
```

Download `wasmtime` source and copy the WIT files to `wit/deps`

```shell
# In `~/nakame` directory
wget -O wasmtime-v17.0.1.tar.gz https://github.com/bytecodealliance/wasmtime/archive/refs/tags/v17.0.1.tar.gz
tar zxvf wasmtime-v17.0.1.tar.gz

# `cd ~/nakame/hello-wasi-http`
cp -R ~/nakame/wasmtime-17.0.1/crates/wasi/wit/deps wit/
```

Add the `wasmtime` WIT definitions to `Cargo.toml`
```shell
cargo component add --target --path wit/deps/cli wasi:cli        
cargo component add --target --path wit/deps/clocks wasi:clocks     
cargo component add --target --path wit/deps/filesystem wasi:filesystem
cargo component add --target --path wit/deps/http wasi:http       
cargo component add --target --path wit/deps/io wasi:io         
cargo component add --target --path wit/deps/random wasi:random     
cargo component add --target --path wit/deps/sockets wasi:sockets
```

Add the following to `src/lib.rs` (based on sunfishcode example).
NOTE: changed `Fields` type to `Headers`  

```rust
#![allow(dead_code, unused_imports)]
mod bindings;

pub use bindings::wasi::http::types::{
    Headers , IncomingRequest, OutgoingBody, OutgoingResponse, ResponseOutparam,
};

struct Component;

impl bindings::exports::wasi::http::incoming_handler::Guest for Component {
    fn handle(_request: IncomingRequest, outparam: ResponseOutparam) {
        let hdrs = Headers::new(); // changed from original example
        let resp = OutgoingResponse::new(hdrs);
        let body = resp.body().expect("outgoing response");

        ResponseOutparam::set(outparam, Ok(resp));

        let out = body.write().expect("outgoing stream");
        out.blocking_write_and_flush(b"Hello, wasi:http/proxy world!\n")
            .expect("writing response");

        drop(out);
        OutgoingBody::finish(body, None).unwrap();
    }
}
```

---

### Build and run 

Build the project

```shell
cargo component build --release
```

Start an HTTP server. Defaults to `0.0.0.0:8080`, or optionally use `--addr=` flag to change host and port

```shell
wasmtime serve target/wasm32-wasi/debug/hello_wasi_http.wasm
```

```shell
curl http://localhost:8080
Hello, wasi:http/proxy world!
```


---

### Links

Command and Reactor

- https://github.com/WebAssembly/WASI/issues/13
- https://github.com/WebAssembly/wasi-libc/pull/74
- https://doc.rust-lang.org/reference/linkage.html
- https://rustwasm.github.io/wasm-pack/book/tutorials/npm-browser-packages/template-deep-dive/cargo-toml.html
